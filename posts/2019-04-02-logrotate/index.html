<!DOCTYPE html>
<html>

<head>
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">

<meta name="description" content="stones blog.">
<title>
    logrotate를 활용한 로그관리(compress, lotate) - my name is Stones
</title>


<link rel="shortcut icon" href="/sam.ico">








<link rel="stylesheet" href="/css/main.min.c5514d3530979d291f3497facc20da1cec870028dbc2a3630b64bab8721bbe49.css" integrity="sha256-xVFNNTCXnSkfNJf6zCDaHOyHACjbwqNjC2S6uHIbvkk=" crossorigin="anonymous" media="screen">




  






<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic">

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://example.com/tn.png"/>

<meta name="twitter:title" content="logrotate를 활용한 로그관리(compress, lotate)"/>
<meta name="twitter:description" content="logrotate를 활용한 로그 관리 (compress, lotate)&nbsp;¶ 상황 : 아파치 로그 파일을 주기적으로(하루 단위로 rotation) 압축하여 일 별 관리하고 싶을 경우
기존 아파치 설정
httpd.conf&nbsp;¶ CustomLog &ldquo;|/program/httpd-2.2.20/bin/rotatelogs -l /program/httpd-2.2.20/logs/%y%m%d.sample.activity_log 86400&rdquo; combined env=!nolog
ErrorLog &ldquo;|/program/httpd-2.2.20/bin/rotatelogs -l /program/httpd-2.2.20/logs/%y%m%d.sample.error_log 86400&rdquo;
 하루 단위로 rotation 하고 있었지만 압축 저장하고 있지 않음.  해결방법 : 리눅스 기본 logrotate 활용!
 * logrotate란?
로그 파일(시스템 로그)을 rotates, compresses, and mails 을 할 수 있다. 설정 파일을 변경해도 관련 프로세스를 새로 시작할 필요 없이 cron 데몬이 주기적으로 실행 시켜준다."/>

<meta property="og:title" content="logrotate를 활용한 로그관리(compress, lotate)" />
<meta property="og:description" content="logrotate를 활용한 로그 관리 (compress, lotate)&nbsp;¶ 상황 : 아파치 로그 파일을 주기적으로(하루 단위로 rotation) 압축하여 일 별 관리하고 싶을 경우
기존 아파치 설정
httpd.conf&nbsp;¶ CustomLog &ldquo;|/program/httpd-2.2.20/bin/rotatelogs -l /program/httpd-2.2.20/logs/%y%m%d.sample.activity_log 86400&rdquo; combined env=!nolog
ErrorLog &ldquo;|/program/httpd-2.2.20/bin/rotatelogs -l /program/httpd-2.2.20/logs/%y%m%d.sample.error_log 86400&rdquo;
 하루 단위로 rotation 하고 있었지만 압축 저장하고 있지 않음.  해결방법 : 리눅스 기본 logrotate 활용!
 * logrotate란?
로그 파일(시스템 로그)을 rotates, compresses, and mails 을 할 수 있다. 설정 파일을 변경해도 관련 프로세스를 새로 시작할 필요 없이 cron 데몬이 주기적으로 실행 시켜준다." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://example.com/posts/2019-04-02-logrotate/" />
<meta property="og:image" content="https://example.com/tn.png"/>
<meta property="article:published_time" content="2019-04-01T10:00:50+09:00" />
<meta property="article:modified_time" content="2019-04-01T10:00:50+09:00" /><meta property="og:site_name" content="my name is stones" />


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-XR2Y95VWMZ', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


    

    
    
    
    <title>
        
        logrotate를 활용한 로그관리(compress, lotate)
        
    </title>
</head>

<body>
    
    
    <header class="wrap flex-container">
        <h1>logrotate를 활용한 로그관리(compress, lotate)</h1>
    </header>
    
    <main class="wrap">
        
<div class="flex-container">
    <aside role="complementary">
        Mon Apr 01, 2019 &#183; 558 words
        <div class="tag-container">
            
            
            <span class="tag">
                <a href="/tags/logrotate/">
                    logrotate
                </a>
            </span>
            
            
            
            <span class="tag">
                <a href="/tags/apache/">
                    apache
                </a>
            </span>
            
            
        </div>
    </aside>
    <hr />
    <article role="article">
        
<h1 id="logrotate를-활용한-로그-관리-compress-lotate" class="anchor-link"><a href="#logrotate%eb%a5%bc-%ed%99%9c%ec%9a%a9%ed%95%9c-%eb%a1%9c%ea%b7%b8-%ea%b4%80%eb%a6%ac-compress-lotate">logrotate를 활용한 로그 관리 (compress, lotate)<span class="pilcrow">&nbsp;¶</span></a></h1>
<p>상황 : 아파치 로그 파일을 주기적으로(하루 단위로 rotation) 압축하여 일 별 관리하고 싶을 경우</p>
<p>기존 아파치 설정</p>

<h4 id="httpdconf" class="anchor-link"><a href="#httpdconf">httpd.conf<span class="pilcrow">&nbsp;¶</span></a></h4>
<p>CustomLog    &ldquo;|/program/httpd-2.2.20/bin/rotatelogs -l /program/httpd-2.2.20/logs/%y%m%d.sample.activity_log 86400&rdquo; combined env=!nolog</p>
<p>ErrorLog     &ldquo;|/program/httpd-2.2.20/bin/rotatelogs -l /program/httpd-2.2.20/logs/%y%m%d.sample.error_log 86400&rdquo;</p>
<ul>
<li>하루 단위로 rotation 하고 있었지만 압축 저장하고 있지 않음.</li>
</ul>
<p>해결방법 : 리눅스 기본 logrotate 활용!</p>
<hr>
<p>* logrotate란?</p>
<p>로그 파일(시스템 로그)을 rotates, compresses, and mails 을 할 수 있다.
설정 파일을 변경해도 관련 프로세스를 새로 시작할 필요 없이 cron 데몬이 주기적으로 실행 시켜준다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ vi /etc/cron.daily 
</code></pre></div><!-- raw HTML omitted -->
<p>위 cron을 확인해보면 logrotate 설정 부분을 확인할 수 있다.</p>
<p>logrotate 관련 파일</p>
<ul>
<li>/usr/sbin/logrotate : 데몬의 위치 및 데몬프로그램</li>
<li>/etc/logrotate.conf : 설정 파일.</li>
<li>/etc/logrotate.d : logrotate를 적용할 로그 파일 보관 디렉토리.</li>
<li>/var/lib/logrotate.status : logrotate가 작업 내역 보관 파일.</li>
<li>/etc/cron.daily/logrotate : logrotate : cron 에 의해 일 단위로 실행한다.</li>
</ul>
<p>동작 순서를 살펴보면</p>
<ol>
<li>cron.daily 에서 /usr/sbin/logrotate 호출</li>
<li>/usr/sbin/logrotate 에서 /etc/logrotate.conf 설정파일 참조</li>
<li>/etc/logrotate.conf 설정 파일에서 /etc/logrotate.d 참조 ( logrotate.conf 파일 안에 &ldquo;include /etc/logrotate.d&rdquo;)</li>
</ol>
<p>logrotate가 정상 동작 하는지 최소한의 설정으로 확인해 보자</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ sudo vi /etc/logrotate.d/apache
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">/program/apache/logs/access_log <span style="color:#f92672">{</span>
  size +1k
  missingok
  notifempty
  create <span style="color:#ae81ff">0600</span> root root
  compress
  dateext
  postrotate
    /usr/bin/killall -HUP httpd
  endscript
<span style="color:#f92672">}</span>
</code></pre></div><p>각 옵션들은 잠시 뒤에 상세 설명하고 우선 당장 실행 시켜 보자.</p>
<p>루트 권한으로 아래 명령 실행.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ /usr/sbin/logrotate -f /etc/logrotate.conf
</code></pre></div><p>-f 옵션은 강제 실행 옵션이다 (Tells logrotate to force the rotation, even if it doesn&rsquo;t think this is necessary)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ /usr/sbin/logrotate -d /etc/logrotate.conf
</code></pre></div><p>-d 옵션 : 디버그 모드 (Turns on debug mode and implies -v. In debug mode, no changes will be made to the logs or to the logrotate state file.)</p>
<ul>
<li>
<p>주의사항 : f 옵션이나 d 옵션 하나만 넣고 실행해야 한다. (두 옵션을 동시에 넣고 실행시 정상 동작안되서 한동안 삽질&hellip;.)</p>
</li>
<li>
<p>logrotate 옵션
copytruncate : Truncate the original log file to zero size in place after creating a copy, instead of moving the old log file and optionally creating a new one
copytruncate옵션을 활용하면 postrotate를 통한 httpd 재시작 없이 무중단 로깅이 가능하다.</p>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">/path/to/log <span style="color:#f92672">{</span>
  daily
  copytruncate
  create <span style="color:#ae81ff">0700</span> root root
  compress
  notifempty
  missingok
  dateext
<span style="color:#f92672">}</span>
</code></pre></div><ul>
<li>rotate 30(숫자)  : log파일 30개 이상 되면 삭제</li>
<li>maxage 30(숫자) : 30일 이산된 로그 파일 삭제</li>
<li>size : 지정한 용량이 되면 로그로테이트를 실행한다. 10k, 10M 이런식으로 지정한다.</li>
<li>create : [권한 유저 그룹] 으로 rotation된 로그파일 생성</li>
<li>notifempty : log 내용이 없으면 rotation 하지 않는다.</li>
<li>ifempty : 로그파일이 비어있는 경우에도 로테이트한다.</li>
<li>monthly : 월 단위로 로테이트 한다.</li>
<li>daily : 일 단위로 로테이트 한다.</li>
<li>weekly : 주 단위로 로테이트 한다.</li>
<li>compress : rotate 된 로그 gzip 압축</li>
<li>nocompress : 압축을 원치 않는다.</li>
<li>mail admin@mail : 로테이트 설정에 의해 보관주기가 끝난 파일을 메일로 발송한다.</li>
<li>mailfirst admin@mail : 로테이트시 신규파일 이전의 로그를 메일로 발송한다.</li>
<li>nomail : 메일로 통보받지 않음.</li>
<li>errors admin@mail : 로테이트 실행시 에러가 발생하면 이메일로 통보한다.</li>
<li>prerotate-endscript : 사이의 명령어를 로그파일 처리전에 실행한다.</li>
<li>postrotate-endscript : 사이의 명령어를 로그파일 처리후에 실행한다.</li>
<li>extension : 로테이트 후 생성되는 파일의 확정자를 지정한다.</li>
<li>copytruncate : 이옵션을 넣지 않으면 현재 사용중인 로그를 다른이름으로 move하고 새로운 파일을 생성한다.
이 외의 옵션은 하단 참조에 link를 참조하거나 man logrotate를 확인하면 된다.</li>
</ul>
<p>보통은 rotation 후 아래 postrotate를 통해 httpd 를 재시작 해준다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">postrotate
    /usr/bin/killall -HUP httpd
endscript
</code></pre></div><p>이 때 두가지 대안이 있다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">1. killall -HUP 프로세스이름  
<span style="color:#f92672">(</span>예&gt; /usr/bin/killall -HUP httpd<span style="color:#f92672">)</span>
2. kill -HUP 프로세스번호 
<span style="color:#f92672">(</span>예&gt; /usr/bin/kill -HUP <span style="color:#e6db74">`</span>cat /daum/program/apache/logs/httpd.pid 2&gt; /dev/null<span style="color:#e6db74">`</span> 2&gt; /dev/null <span style="color:#f92672">||</span> true<span style="color:#f92672">)</span>
</code></pre></div><p>logrotate 정의 : <a href="http://manpages.ubuntu.com/manpages/precise/man8/logrotate.8.html">http://manpages.ubuntu.com/manpages/precise/man8/logrotate.8.html</a></p>
<p>Understanding logrotate - part 1 : <a href="http://www.rackspace.com/knowledge_center/article/understanding-logrotate-part-1">http://www.rackspace.com/knowledge_center/article/understanding-logrotate-part-1</a></p>
<p>How to Rotate Apache Log Files in Linux : <a href="http://www.thegeekstuff.com/2011/07/rotate-apache-logs/">http://www.thegeekstuff.com/2011/07/rotate-apache-logs/</a></p>
<p>logrotate example :</p>
<ul>
<li>
<p><a href="http://www.thegeekstuff.com/2010/07/logrotate-examples/%5B%5D(http://www.thegeekstuff.com/2010/07/logrotate-examples)">http://www.thegeekstuff.com/2010/07/logrotate-examples/[](http://www.thegeekstuff.com/2010/07/logrotate-examples)</a></p>
</li>
<li>
<p><a href="http://unix.stackexchange.com/questions/47688/how-to-avoid-apache-reload-when-rotating-logs">http://unix.stackexchange.com/questions/47688/how-to-avoid-apache-reload-when-rotating-logs</a></p>
</li>
</ul>
<p>출처: <a href="https://blueskai.tistory.com/101">https://blueskai.tistory.com/101</a> [blueskai]</p>

    </article>
</div>
<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "dschoi-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


        
<nav role="navigation" class="flex-container bottom-menu">
    
<hr />
<p>


    
        <a href="/posts">back</a>
        
            &#183;
        
    

    
        
            <a href="/posts">posts</a>
        
    
    
        
            &#183; 
            <a href="/gallery">gallery</a>
        
            &#183; 
            <a href="/portfolio">portfolio</a>
        
            &#183; 
            <a href="/about">who is stones?</a>
        
    
    &#183; 
    <a href="/">
        main
    </a>

</p>
</nav>

    </main>
    
    <footer class="flex-container footer">
</footer>
    
    
</body>

</html>