<!DOCTYPE html>
<html>

<head>
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">

<meta name="description" content="stones blog.">
<title>
    성능테스트 삽질기 - my name is Stones
</title>


<link rel="shortcut icon" href="/sam.ico">








<link rel="stylesheet" href="/css/main.min.c5514d3530979d291f3497facc20da1cec870028dbc2a3630b64bab8721bbe49.css" integrity="sha256-xVFNNTCXnSkfNJf6zCDaHOyHACjbwqNjC2S6uHIbvkk=" crossorigin="anonymous" media="screen">




  






<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic">

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://example.com/tn.png"/>

<meta name="twitter:title" content="성능테스트 삽질기"/>
<meta name="twitter:description" content="상품통계 범례 API 개발 완료 후 성능테스트&nbsp;¶ API 개발을 끝낸 후 성능테스트를 해야해서 ngrinder 설치 후 테스트 수행을 시작했다.
목표 성능 수치 : 180tps - 서버가 두대니 한대에 100정도만 나오면 좋겠다
처참한 성능
cpu 사용률 100% / cpu load 10.
성능테스트 결과
   TPS 46.3     Peak TPS 54.5   Mean Test Time 173.42 ms   Executed Tests 13,698   Successful Tests 13,698    문제가 무엇일까?"/>

<meta property="og:title" content="성능테스트 삽질기" />
<meta property="og:description" content="상품통계 범례 API 개발 완료 후 성능테스트&nbsp;¶ API 개발을 끝낸 후 성능테스트를 해야해서 ngrinder 설치 후 테스트 수행을 시작했다.
목표 성능 수치 : 180tps - 서버가 두대니 한대에 100정도만 나오면 좋겠다
처참한 성능
cpu 사용률 100% / cpu load 10.
성능테스트 결과
   TPS 46.3     Peak TPS 54.5   Mean Test Time 173.42 ms   Executed Tests 13,698   Successful Tests 13,698    문제가 무엇일까?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://example.com/posts/blog1-md/" />
<meta property="og:image" content="https://example.com/tn.png"/>
<meta property="article:published_time" content="2020-09-29T15:52:51+09:00" />
<meta property="article:modified_time" content="2020-09-29T15:52:51+09:00" /><meta property="og:site_name" content="my name is stones" />


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-XR2Y95VWMZ', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


    

    
    
    
    <title>
        
        성능테스트 삽질기
        
    </title>
</head>

<body>
    
    
    <header class="wrap flex-container">
        <h1>성능테스트 삽질기</h1>
    </header>
    
    <main class="wrap">
        
<div class="flex-container">
    <aside role="complementary">
        Tue Sep 29, 2020 &#183; 337 words
        <div class="tag-container">
            
        </div>
    </aside>
    <hr />
    <article role="article">
        
<h1 id="상품통계-범례-api-개발-완료-후-성능테스트" class="anchor-link"><a href="#%ec%83%81%ed%92%88%ed%86%b5%ea%b3%84-%eb%b2%94%eb%a1%80-api-%ea%b0%9c%eb%b0%9c-%ec%99%84%eb%a3%8c-%ed%9b%84-%ec%84%b1%eb%8a%a5%ed%85%8c%ec%8a%a4%ed%8a%b8">상품통계 범례 API 개발 완료 후 성능테스트<span class="pilcrow">&nbsp;¶</span></a></h1>
<p>API 개발을 끝낸 후 성능테스트를 해야해서 ngrinder 설치 후 테스트 수행을 시작했다.</p>
<p>목표 성능 수치 : 180tps - 서버가 두대니 한대에 100정도만 나오면 좋겠다</p>
<p><strong>처참한 성능</strong></p>
<p>cpu 사용률 100% / cpu load 10.</p>
<p><p style="text-align:center;">
    <img src="blog_01.png" alt="blog_01"  />
</p>
</p>
<p><strong>성능테스트 결과</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">TPS</th>
<th><strong>46.3</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Peak TPS</td>
<td><strong>54.5</strong></td>
</tr>
<tr>
<td style="text-align:left">Mean Test Time</td>
<td>173.42  <code>ms</code></td>
</tr>
<tr>
<td style="text-align:left">Executed Tests</td>
<td>13,698</td>
</tr>
<tr>
<td style="text-align:left">Successful Tests</td>
<td>13,698</td>
</tr>
</tbody>
</table>

<h4 id="문제가-무엇일까" class="anchor-link"><a href="#%eb%ac%b8%ec%a0%9c%ea%b0%80-%eb%ac%b4%ec%97%87%ec%9d%bc%ea%b9%8c"><strong>문제가 무엇일까?</strong><span class="pilcrow">&nbsp;¶</span></a></h4>

<h5 id="첫번째-의심" class="anchor-link"><a href="#%ec%b2%ab%eb%b2%88%ec%a7%b8-%ec%9d%98%ec%8b%ac"><strong>첫번째 의심.</strong><span class="pilcrow">&nbsp;¶</span></a></h5>
<p>스카우터 xlog 를 확인해보았는데 DDB( dynamodb response 시간이 1.5초나 걸리는것을 확인.)</p>
<p><p style="text-align:center;">
    <img src="blog_02.png" alt="blog_02"  />
</p>
</p>
<p>ddb 설정 및 rcu(읽기 용량) 설정을 늘렸다.</p>
<p><strong>하지만 결과는 변하지 않았다. ㅠㅜ (1)</strong></p>

<h5 id="두번째-의심" class="anchor-link"><a href="#%eb%91%90%eb%b2%88%ec%a7%b8-%ec%9d%98%ec%8b%ac"><strong>두번째 의심</strong><span class="pilcrow">&nbsp;¶</span></a></h5>
<p>JAVA DDB client 풀을 늘려야 하나? mybatis 의 db 커넥션풀같은게 있으니 해당 풀에 접근하고 해제하는데 오래걸려서 문제가 생기지 않을까? 하는 의심을 했다.</p>
<p>파격적으로 maxConnection 100으로 설정했다.</p>
<p><p style="text-align:center;">
    <img src="blog03.png" alt="blog03"  />
</p>
</p>
<p><strong>하지만 결과는 변하지 않았다. ㅠㅜ (2)</strong></p>

<h5 id="세번째-의심" class="anchor-link"><a href="#%ec%84%b8%eb%b2%88%ec%a7%b8-%ec%9d%98%ec%8b%ac"><strong>세번째 의심.</strong><span class="pilcrow">&nbsp;¶</span></a></h5>
<p>Spring data dyanmodb 요 아이가 성능이 안나오나? 그러면 그냥 aws에서 제공하는 sdk 를 사용해서 해보자.</p>
<p><p style="text-align:center;">
    <img src="blog04.png" alt="blog04"  />
</p>
</p>
<p><strong>하지만 결과는 변하지 않았다. ㅠㅜ (3)</strong></p>

<h5 id="포기-서버-성능을-높이자" class="anchor-link"><a href="#%ed%8f%ac%ea%b8%b0-%ec%84%9c%eb%b2%84-%ec%84%b1%eb%8a%a5%ec%9d%84-%eb%86%92%ec%9d%b4%ec%9e%90"><strong>포기. 서버 성능을 높이자</strong><span class="pilcrow">&nbsp;¶</span></a></h5>
<p><strong>t3.small → c5.xlarge</strong></p>
<p>무려 cpu 4코어 짜리다.</p>
<p>역시 돈이다! 기존 t3.small 보다 무려 2배</p>
<table>
<thead>
<tr>
<th style="text-align:left">TPS</th>
<th><strong>99</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Peak TPS</td>
<td><strong>132</strong></td>
</tr>
<tr>
<td style="text-align:left">Mean Test Time</td>
<td>40.19  <code>ms</code></td>
</tr>
<tr>
<td style="text-align:left">Executed Tests</td>
<td>59,027</td>
</tr>
<tr>
<td style="text-align:left">Successful Tests</td>
<td>59,023</td>
</tr>
<tr>
<td style="text-align:left">Errors</td>
<td>4</td>
</tr>
</tbody>
</table>
<p>cpu 도 75% 사용. 그래도 높지만 기존 아이들 생각하면 엄청난 차이다. 좋네 이렇게 할까..?</p>
<p><p style="text-align:center;">
    <img src="blog05.png" alt="blog05"  />
</p>
</p>

<h5 id="다시-한번-더-코드를-확인-해보자" class="anchor-link"><a href="#%eb%8b%a4%ec%8b%9c-%ed%95%9c%eb%b2%88-%eb%8d%94-%ec%bd%94%eb%93%9c%eb%a5%bc-%ed%99%95%ec%9d%b8-%ed%95%b4%eb%b3%b4%ec%9e%90"><strong>다시 한번 더 코드를 확인 해보자.</strong><span class="pilcrow">&nbsp;¶</span></a></h5>
<p>유환성 팀장님 같이 코드를 보면서 의심되는 부분을 하나씩 확인해보았다.</p>
<p>유 : 정확하게 무슨 일을 할까요? 나: 이런 저런 일을 하고 있어요. 유: 그럼 이건 무슨 일을 할까요? 나: 이건 이런 저런 일을 해요. 유: 혹시 로그 레벨은 info 인가요? 나: &hellip;&hellip; debug 네요..</p>
<p>한가지 자기 변호를 해보자면 기존 회사에서는 alpha 는 개발이었다. 알파의 log level 을 debug 로 해놓은 상태였다.</p>
<table>
<thead>
<tr>
<th style="text-align:left">무신사</th>
<th style="text-align:left">기존회사</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">devel</td>
<td style="text-align:left">alpha</td>
</tr>
<tr>
<td style="text-align:left">alpha</td>
<td style="text-align:left">beta</td>
</tr>
<tr>
<td style="text-align:left">prod</td>
<td style="text-align:left">release</td>
</tr>
</tbody>
</table>

<h4 id="마지막-결과" class="anchor-link"><a href="#%eb%a7%88%ec%a7%80%eb%a7%89-%ea%b2%b0%ea%b3%bc">마지막 결과.<span class="pilcrow">&nbsp;¶</span></a></h4>
<p><p style="text-align:center;">
    <img src="blog06.png" alt="blog06"  />
</p>
</p>
<table>
<thead>
<tr>
<th style="text-align:left">TPS</th>
<th><strong>158.5</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Peak TPS</td>
<td><strong>179</strong></td>
</tr>
<tr>
<td style="text-align:left">Mean Test Time</td>
<td>12.43  <code>ms</code></td>
</tr>
<tr>
<td style="text-align:left">Executed Tests</td>
<td>23,774</td>
</tr>
<tr>
<td style="text-align:left">Successful Tests</td>
<td>23,772</td>
</tr>
</tbody>
</table>
<p><strong>cpu 사용률</strong></p>
<p><strong>50프로 미만 정상동작 한다. ㅠㅜ 기쁘다..</strong></p>
<p><p style="text-align:center;">
    <img src="blog07.png" alt="blog07"  />
</p>
</p>
<p>DDB RCU</p>
<p>여섯시쯤에 파랗게 뾰족하게 뒤어나온 아이가 테스트 했을때의 그래프이다.</p>
<p>최대 30개까지 썼으니 운영에서 사용할땐 적어도 30이상으로 사용을 해야겠다.</p>
<p><!-- raw HTML omitted --></p>

<h2 id="결론" class="anchor-link"><a href="#%ea%b2%b0%eb%a1%a0">결론.<span class="pilcrow">&nbsp;¶</span></a></h2>
<p>허무하지만.. 그래도 소스코드 문제가 아니어서 다행이었다.</p>
<p>여기서 얻은 교훈은 문제가 없다고 생각되면 설정부터 차근차근 하나씩 보면서 확인을 하자</p>
<p><strong>로그 설정 DEBUG는 운영에 나가면 안된다.</strong></p>

    </article>
</div>
<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "dschoi-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


        
<nav role="navigation" class="flex-container bottom-menu">
    
<hr />
<p>


    
        <a href="/posts">back</a>
        
            &#183;
        
    

    
        
            <a href="/posts">posts</a>
        
    
    
        
            &#183; 
            <a href="/gallery">gallery</a>
        
            &#183; 
            <a href="/portfolio">portfolio</a>
        
            &#183; 
            <a href="/about">who is stones?</a>
        
    
    &#183; 
    <a href="/">
        main
    </a>

</p>
</nav>

    </main>
    
    <footer class="flex-container footer">
</footer>
    
    
</body>

</html>